---
title: "Bayesian Modeling"
author: "Ben Gerber"
format: pdf
editor: visual
---

## Load Libraries, Data, and Show Data Structure and Preliminary Missing

```{r}
library(tidyverse)
library(RSocrata)
library(gtsummary)
library(brms)
library(tidybayes)

df <- read.socrata(
  url = "https://data.cdc.gov/resource/n8mc-b4w4.json?$limit=100000"
)

str(df)
```

{{< pagebreak >}}

## Convert "Missing" and "Unknown" text to NA, make age ordinal

```{r}
df_recode <- df |>
  mutate(across(everything(), ~if_else(. %in% c("Unknown", "Missing", "NA"), NA_character_, .))) |>
  mutate(hosp_yn = factor(hosp_yn, levels = c("No", "Yes")))

df_recode$age_group <- ordered(df_recode$age_group)
```

{{< pagebreak >}}

## Make an Example Bayesian Model with Age and Race Only

```{r}
mod_1 <- brm(
  hosp_yn ~ age_group + race,
  data = df_recode,
  iter = 1000,
  chains = 4,
  cores = getOption("mc.cores", 4),
  family = bernoulli
)
```

### Results Summary

```{r}
summary(mod_1)
```

Noted increased risk of hospitalization with older age, and decreased risk with White race.

The ordinal age group gives contrasts for linear, quadratic and cubic (linear significant).

### Check Posterior Distributions and Chains Mixing

```{r}
plot(mod_1)
```

{{< pagebreak >}}

## Make a hierarchical model with state

Added more iterations given lower effect sizes.

```{r}
mod_2 <- brm(
  hosp_yn ~ age_group + race + (1 | res_state),
  data = df_recode,
  iter = 2500,
  chains = 4,
  cores = getOption("mc.cores", 4),
  family = bernoulli
)
```

### Results summary

```{r}
summary(mod_2)
```

### Explore conditional effects of model

```{r}
conditional_effects(mod_2)
```

Age clearly increases risk, but after adjusting for age, race not so much.

### Posterior predictive check of model estimating probability

```{r}
pp_check(mod_2, type = "stat")
```

### Show results by state

epred draws from the expectation of the posterior predictive distribution. Is that correct?

```{r}
# Get observed hospitalization proportions by state (complete cases)
obs_hosp <- df_recode |>
  select(age_group, race, res_state, hosp_yn) |>
  na.omit() |>
  reframe(prop = sum(hosp_yn == "Yes") / n(), .by = "res_state")

# Show a plot by state, with predictions and observed values
df_recode |>
  data_grid(res_state, age_group, race) |>
  add_epred_draws(mod_2, allow_new_levels = TRUE) |>
  ggplot(aes(x = .epred, y = res_state)) +
    stat_pointinterval() +
    scale_y_discrete(limits = rev) +
    geom_point(data = obs_hosp, aes(x = prop, y = res_state), color = "green")
```

### Show a state with high predicted value (Arkansas)

```{r}
df_recode |>
  select(age_group, race, res_state, hosp_yn) |>
  filter(res_state == "AR") |>
  na.omit()
```

There were <20 cases with complete variables, and most were hospitalized.

